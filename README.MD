# Программа для загрузки отчетов с сайта АТС (персональных и публичных)

Программа позволяет скачивать и распределять по заданным папкам отчеты с сайта АО "АТС" (<https://www.atsenergo.ru/>). Отчеты могут скачиваться с публичных страниц сайта, так и из персонального раздела участника оптового рынка электроэнергии и мощности.

Программа работает в режиме командной строки, что позволяет гибко настроить расписание загрузки.
Настройки по загрузке отчетов необходимо указать в файлах ReportSettingsPart.xml (для персональных отчетов участников) и ReportSettingsPubl.xml (для публичных отчетов).

В случае загрузки наиболее важных отчетов программа высылает по электронной почте уведомление о том, что такой отчет загружен.

## Синтаксис:
```BASH
python main.py параметр=значение
```

Ключи:
+ `--user-pass`
Если указать данный ключ, то программа запрашивает пароль текущего пользователя и сохраняет его в keyring (для дальнейшей рассылки уведомлений по электронной почте).

   Пример: `python main.py --user-pass`

+ `--participant-pass=[код участника]`
Если указать данный ключ, то программа запрашивает пароль для данного кода участника и сохраняет его в `keyring` (для дальнейшей авторизации на сайте АТС). Код участника здесь - 8-мибуквенный код, который выдается участнику оптового рынка электроэнергии и мощности при его регистрации в торговой системе. Если код не будет указан, то программа сможет скачивать только публичные отчеты.

   Пример: `python main.py --participant-pass=XXXENERG`

Виды параметров:
+ `overwrite=true|false`
Параметр определяет, нужно перезаписывать уже существующие на диске файлы отчетов или нет.
По умолчанию `overwrite=false`

+ `dt=YYYYMMDD`
 (например `dt=20210910`)
Параметр задает загрузку отчетов только за одну конкретную дату.

+ `dt1=YYYYMMDD` (например `dt1=20210910`) или `dt1=-x` (например `dt1=-10`)
Загрузка отчетов с даты `dt1` до даты `dt2` (если она задана в параметрах) либо до текущей даты (если `dt2` не задана).
Параметр может задаваться в виде конкретной даты в формате `YYYYMMDD` либо со смещением влево на x дней.

+ `dt2=YYYYMMDD` (например `dt=20210910`)
Загрузка отчетов до даты `dt2`
По умолчанию `dt2` равен текущей дате

+ `load_type=private|public`
Загрузка персональных либо публичных отчетов.
По умолчанию `load_type=private`

+ `partcode=[Код участника]` (например `partcode=XXXENERG`)
Код участника для загрузки
Можно коды задавать через запятую, например `partcode=XXXENERG,XXXENER2,XXXENER3`.
Если не задан, то грузятся все участники, которые прописаны в настройках

+ `reportcode=[Код отчета]` (например `reportcode=carana_sell_units`)
Код отчета для загрузки. Можно задать несколько через запятую.
Если не задан, то грузятся все отчеты, которые имеются в настройках.

## Установка

### Установка Python и зависимостей
- Инструкции по установке [Python] и Git см. на официальных сайтах (если не установлено).
- Клонирование репозитория (командная строка): `git clone https://github.com/Vasilii-byte/py_ats.git`
- Переходим в папку с наименованием py_ats, устанавливаем виртуальное окружение: `python -m venv venv`
- Установка зависимостей: `pip install -r requirements.txt`

### Настройка окружения
Создаем в папке файл с наименованиеми `.env` и задаем настройки:
```
HOME_DIR_FOR_SAVE=C:\Папка для отчетов\
TIME_BETWEEN_TIMEOUT=5
TIMEOUT_IN_SECONDS=3
REPORT_SETTINGS_PUB_FILE = ReportSettingsPubl.xml
REPORT_SETTINGS_PRIV_FILE = ReportSettingsPart.xml
PARTICIPANT_SETTINGS_FILE = ParticipantSettings.xml
MAX_TIMESHIFT = -65
DOMAIN=org.ru
SMTP_SERVER=smtp.org.ru
VERIFY_STATUS=0
```
Описание параметров:
- HOME_DIR_FOR_SAVE - корневая папка для сохранения отчетов
- TIMEOUT_IN_SECONDS - таймаут (в секундах). Если отчеты загружаются слишком быстро, сервер может ограничить для такого соединения скорость загрузки, посчитав такое соединение DDOS-атакой. Поэтому приходится искуственно снижать скорость загрузки, устанавливая паузу на заданную в этом параметре длительность
- TIME_BETWEEN_TIMEOUT - интервал времени между паузами. Можно подобрать вручную оптимальный вариант
- REPORT_SETTINGS_PUB_FILE - наименование файла с настройками публичных отчетов
- REPORT_SETTINGS_PRIV_FILE - наименование файла с настройками персональных отчетов
- PARTICIPANT_SETTINGS_FILE - наименование файла с настройками участников оптового рынка электроэнергии и мощности (участник может быть один, а может быть и несколько)
- MAX_TIMESHIFT - если период загрузки не указан, то будут просматриваться отчеты с даты, смещенной на количество дней, указанных в этом параметре (за 65 дней то текущей даты)
- DOMAIN - домен отправителя электронной почты
- SMTP_SERVER - SMTP-сервер, через который будут направляться письма о загрузке важных отчетов
- VERIFY_STATUS - если равен нулю, то программа не будет проверять SSL-сертификат сайта загрузки (бывает, что корпоративные системы подменяют сертификат сайта, и возникают проблемы с цепочкой проверки сертификатов)

### Настройки отчетов для загрузки и параметров участников
- Настраиваем файлы отчетов, указанные в `.env` файле как REPORT_SETTINGS_PRIV_FILE и REPORT_SETTINGS_PUB_FILE. Начальные настройки уже заданы в файлах.
- Настраиваем файл PARTICIPANT_SETTINGS_FILE
- Далее нужно задать пароль пользователя, под которым программа будет направлять сообщения на электронную почту. Для этого нужно запусть программу с ключом user-pass:  `python main.py --user-pass`. Программа предложить ввести пароль
- Если планируется скачиваение персональных отчетов участника рынка, то нужно запустить программу с ключом participant-pass: `python main.py --participant-pass=XXXENERG`


## Примеры
-  
```CMD
python main.py dt1=-5 source_type=ats_reports overwrite=false reportcode=cfrliab,mtrx,PENYLIAB,cfrliabdpg,peny_uved,CFR_PART_BUH_INFO,CFR_PART_LIAB_DEL_NOTICE,cessinfo,komreestr,CFR_PART_DPMV_NOTICE,CFR_RD_CLOSE_NOTIF,necessity
```
   
   В этом примере загружаются персональные (не указан ключ `load_type`) отчеты по всем участникам, указанным в файле с настройками участников (т.к. конкретный участник не указан в ключе `partcode`). Отчеты загружаются за 5 прошедших дней с даты загрузки (`dt1=-5`)
   
   Если отчет есть, то он не перезаписывается (`overwrite=false`). 
   
   Коды загружаемых отчетов перечислены в ключе `reportcode` (cfrliab, mtrx, PENYLIAB,cfrliabdpg, peny_uved, CFR_PART_BUH_INFO, CFR_PART_LIAB_DEL_NOTICE, cessinfo, komreestr, CFR_PART_DPMV_NOTICE, CFR_RD_CLOSE_NOTIF, necessity)


## Лог
Логирование осуществляется в файл "LOG\py_ats.log"

Пример, как можно прочесть лог в powershell:
1) список загруженных файлов за 17.07.2022
```PS
Select-string "Log\py_ats.log" -Pattern "2022-07-17.+file"
```
2) список ошибок в июле 2022 года
```PS
Select-string "Log\py_ats.log" -Pattern "2022-07-.+error"
```
3) время загрузки
```PS
Select-string "Log\py_ats.log" -Pattern "complete"
```

## Автор: [Василий Глушков]

[//]: #
[Python]: <https://www.python.org>
[Василий Глушков]: <https://github.com/Vasilii-byte>